Federated Load Balancing
========================

**Authors:** GabrielSVinha, walteraa, aembrito, Marcus Carvalho


- [Introduction](#introduction)
  - [Background](#background)
  - [Purpose](#purpose)
- [Requirements](#requirements)
  - [Functional](#functional)
  - [Availability](#availability)
  - [Extensibility](#extensibility)
- [Design](#design)
  - [Archtecture Overview](#archtecture-overview)
  - [Federated HAProxy Controller](#federated-haproxy-controller)
  - [Configured HAProxy](#configured-haproxy)
- [Future work](#future-work)

------------
Introduction
------------

### Background ###
* [Federated Services](https://kubernetes.io/docs/tasks/federation/federation-service-discovery/)
* [HAProxy Load Balancing](http://www.haproxy.org/)

### Purpose ###
Federated load balancing has n purposes:

1. Balance traffic between applications running in different clouds.

2. Make possible to configure the load balancer in terms of policies, checks, etc.

------------
Requirements
------------

### Functional ###

* fed-lb has an unique entrypoint in the form of an IP address

* fed-lb is capable of mapping n services running in n clusters on the federation context

* fed-lb is capable of handle traffic incoming to the specified entrypoint to the services mapped

* fed-lb is capable of update its configuration in case of deletion/update of the mapped services (e.g. when a services has its external ip updated)

* fed-lb is capable of performing a cronological health check in all mapped services and decide the error handling in case of unavailabillity

### Network Visibility ###

When specifying a multicluster envinronment, it is a requisite that the host cluster (the cluster hosting `federation-controller-manager` and `federation-api-server`) has access to the endpoints in the other cluster in the federation. You cannot map an external ip from an internal network, therefore, we assume that all servies created with `type: LoadBalancer` will then have public ip adresses.

------
Design
------

### Architecture overview ###
![Federated loab balancer archtecture overview](https://i.imgur.com/PZ1girT.jpg)

### Federated HAProxy Controller ###

This proposal is usibng the definitions of micro services archtectures to provision a controller to all the resources used in here. The **federated HAProxy controllerr** is due to manage the Load Balancer container (specified below) and all resources attached to it.

To configure a new federated load balancer controller, you need to create a secret with the endpoint, context, client cetificates and key data to the federation system. Then, upload it as a volume to the deployment of the controller. You can see an example [here](https://github.com/GabrielSVinha/haproxy-fic/blob/master/example/controller.yaml)

After that, the controller will automatically create a [Configured HAProxy](#configured-haproxy) and a public Service to expose it to the world. This service's External IP will be the federation application entrypoint, with it, the [Configured HAProxy](#configured-haproxy) will then redirect requests to the underlying clusters.

The controller is responsible to map new resources and clusters created, therefore is also responsible for updating the Load Balancer to redirect traffic to the new set of back ends on each underlying cluster.

### Configured HAProxy ###

This component is built in the form of a deployment with 1 replica of a Pod. The most important characteristics are:

1. The HAProxy Loab Balancer does not know kubernetes resources

2. Configuration files are generated by the controller (see item above) and loaded to the HAProxy LB, in it there will be all external IPs associated to the application in each cluster.

3. This component is generated everytime an update is done by the controller (e.g. on a failed healthcheck, new ip address, etc.)

-----------
Future work
-----------

In the future, there will be possible to create a federated LOab Balancer as a kubernetes resource. That way, all the automated work built by this controller will be transferred to federation code.